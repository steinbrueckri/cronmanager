# CronManager

Go-based cron job wrapper for Prometheus monitoring via Node Exporter's TextFile collector.

Tracks execution time, exit status, and timeout detection with metrics output for Prometheus.

## Requirements

- Prometheus Node Exporter with TextFile collector enabled
- Default path: `/var/lib/node_exporter/` (override via `COLLECTOR_TEXTFILE_PATH`)

## Quick Start

```bash
# Install tools (brew install just goreleaser golangci-lint)
just setup              # Install dev dependencies
just build              # Build for current platform
just install            # Install to /usr/local/bin (requires sudo)
```

### Release Process

**Create Release:**

```bash
# 1. Run checks
just check

# 2. Create release (updates version, commits, tags, builds)
just release v1.2.0
git push origin v1.2.0
```

The `release` command automatically:

- Updates version in main.go
- Commits and pushes changes
- Creates git tag
- Builds all platforms
- Creates GitHub release with changelog

**Release includes:**

- Binaries for linux/darwin (amd64, arm64, 386)
- Archives: `cronmanager-{version}.{os}-{arch}.tar.gz`
- Auto-generated changelog from conventional commits

## Usage

```bash
cronmanager -c COMMAND -n JOBNAME [-t TIMEOUT] [-l LOGFILE] [-i]
```

**Required:**

- `-c` Command to execute (binary path + args, no shell built-ins)
- `-n` Job name for metrics

**Optional:**

- `-t` Timeout in seconds (default: 3600) - sets `delayed=1` metric when exceeded
- `-l` Log file path (stdout/stderr)
- `-i` Idle for 60s to let Prometheus scrape metrics

**Examples:**

```bash
cronmanager -c "/usr/bin/php /var/www/app/console task" -n update_entities_cron -t 1800
cronmanager -c "/usr/bin/python3 /path/script.py" -n python_job -l /var/log/job.log
```

**Note:** Cannot use shell operators (`>`, `|`, `;`) - command must be a binary with args.

## Metrics

Writes to `$COLLECTOR_TEXTFILE_PATH/{jobname}.prom`:

```prometheus
# HELP cronjob metric generated by cronmanager
# TYPE cronjob gauge
cronjob{name="myjob",dimension="run"} 1          # Currently running
cronjob{name="myjob",dimension="failed"} 0       # Exit status (0=success, 1=failed)
cronjob{name="myjob",dimension="delayed"} 0      # Timeout exceeded (0=ok, 1=delayed)
cronjob{name="myjob",dimension="duration"} 42    # Runtime in seconds
cronjob{name="myjob",dimension="last"} 1704636000 # Last run timestamp
```

## Testing

Run with `just ci`

## License

MIT
